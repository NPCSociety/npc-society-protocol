name: Protocol CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  BUF_VERSION: "1.28.1"

jobs:
  # Lint and check for breaking changes
  lint-breaking:
    name: Buf Lint & Breaking Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for breaking change detection

      - name: Setup Buf
        uses: bufbuild/buf-setup-action@v1
        with:
          version: ${{ env.BUF_VERSION }}

      - name: Buf Lint
        uses: bufbuild/buf-lint-action@v1
        with:
          input: proto

      - name: Buf Breaking Change Detection
        uses: bufbuild/buf-breaking-action@v1
        with:
          input: proto
          against: "https://github.com/${{ github.repository }}.git#branch=main,subdir=proto"
        # Only run on PRs (main branch has nothing to compare against on push)
        if: github.event_name == 'pull_request'

  # Generate code from proto files
  generate:
    name: Generate Stubs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Buf
        uses: bufbuild/buf-setup-action@v1
        with:
          version: ${{ env.BUF_VERSION }}

      - name: Generate Code
        run: buf generate

      - name: Upload Generated Java
        uses: actions/upload-artifact@v4
        with:
          name: generated-java
          path: gen/java/
          retention-days: 7

      - name: Upload Generated Rust
        uses: actions/upload-artifact@v4
        with:
          name: generated-rust
          path: gen/rust/
          retention-days: 7

  # Build Java example
  build-java:
    name: Build Java Example
    runs-on: ubuntu-latest
    needs: generate
    defaults:
      run:
        working-directory: examples/java
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: Build
        run: ./gradlew build --no-daemon

      - name: Run Tests
        run: ./gradlew test --no-daemon

  # Build Rust example
  build-rust:
    name: Build Rust Example
    runs-on: ubuntu-latest
    needs: generate
    defaults:
      run:
        working-directory: examples/rust
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Protoc
        uses: arduino/setup-protoc@v2
        with:
          version: "24.x"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: examples/rust

      - name: Build
        run: cargo build --release

      - name: Run Tests
        run: cargo test

      - name: Clippy
        run: cargo clippy -- -D warnings

  # Integration test (serialization roundtrip)
  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: [build-java, build-rust]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Buf
        uses: bufbuild/buf-setup-action@v1
        with:
          version: ${{ env.BUF_VERSION }}

      - name: Install Protoc
        uses: arduino/setup-protoc@v2
        with:
          version: "24.x"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Generate Rust Stubs
        run: buf generate

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: examples/rust

      - name: Build Rust Server
        working-directory: examples/rust
        run: cargo build --release

      - name: Start Rust Server (background)
        working-directory: examples/rust
        run: |
          cargo run --release &
          sleep 3  # Wait for server to start

      - name: Verify Server is Running
        run: |
          # Simple connectivity check
          timeout 5 bash -c 'until nc -z localhost 50051; do sleep 1; done'
          echo "Server is running on port 50051"

      - name: Stop Server
        run: pkill -f "npc-society" || true

  # Summary job
  ci-complete:
    name: CI Complete
    runs-on: ubuntu-latest
    needs: [lint-breaking, generate, build-java, build-rust, integration-test]
    if: always()
    steps:
      - name: Check Results
        run: |
          if [ "${{ needs.lint-breaking.result }}" != "success" ]; then
            echo "Lint/Breaking check failed"
            exit 1
          fi
          if [ "${{ needs.generate.result }}" != "success" ]; then
            echo "Code generation failed"
            exit 1
          fi
          if [ "${{ needs.build-java.result }}" != "success" ]; then
            echo "Java build failed"
            exit 1
          fi
          if [ "${{ needs.build-rust.result }}" != "success" ]; then
            echo "Rust build failed"
            exit 1
          fi
          echo "All CI checks passed!"

